<%- include('../layout', { 
    title: title,
    currentPage: 'admin',
    additionalCSS: ['/css/admin.css']
}) %>

<!-- Admin Sidebar -->
<div class="flex min-h-screen bg-gray-100">
    <div class="admin-sidebar w-64 min-h-screen">
        <div class="p-6">
            <div class="flex items-center space-x-3 mb-8">
                <div class="w-10 h-10 bg-gradient-to-br from-yellow-400 to-amber-600 rounded-full flex items-center justify-center">
                    <i class="fas fa-shopping-bag text-white text-lg"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-white">Maraneea Shop</h1>
                    <p class="text-xs text-yellow-200">Admin Panel</p>
                </div>
            </div>

            <nav class="space-y-2">
                <a href="/admin" class="flex items-center space-x-3 px-4 py-3 text-gray-300 hover:text-white hover:bg-amber-600 rounded-lg transition-colors duration-300">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
                <a href="/admin/products" class="flex items-center space-x-3 px-4 py-3 text-gray-300 hover:text-white hover:bg-amber-600 rounded-lg transition-colors duration-300">
                    <i class="fas fa-box"></i>
                    <span>Produk</span>
                </a>
                <a href="/admin/orders" class="flex items-center space-x-3 px-4 py-3 text-gray-300 hover:text-white hover:bg-amber-600 rounded-lg transition-colors duration-300">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Pesanan</span>
                </a>
                <a href="/admin/users" class="flex items-center space-x-3 px-4 py-3 text-gray-300 hover:text-white hover:bg-amber-600 rounded-lg transition-colors duration-300">
                    <i class="fas fa-users"></i>
                    <span>Pengguna</span>
                </a>
                <a href="/admin/database" class="flex items-center space-x-3 px-4 py-3 text-gray-300 hover:text-white hover:bg-amber-600 rounded-lg transition-colors duration-300">
                    <i class="fas fa-database"></i>
                    <span>Database</span>
                </a>
                <a href="/admin/analytics" class="flex items-center space-x-3 px-4 py-3 text-white bg-amber-600 rounded-lg">
                    <i class="fas fa-chart-bar"></i>
                    <span>Analitik</span>
                </a>
                <a href="/admin/settings" class="flex items-center space-x-3 px-4 py-3 text-gray-300 hover:text-white hover:bg-amber-600 rounded-lg transition-colors duration-300">
                    <i class="fas fa-cog"></i>
                    <span>Pengaturan</span>
                </a>
            </nav>
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 admin-content">
        <!-- Header -->
        <div class="bg-white shadow-sm border-b border-gray-200 px-6 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Analitik & Laporan</h1>
                    <p class="text-gray-600">Pantau performa toko dan buat laporan</p>
                </div>
                <div class="flex space-x-3">
                    <select id="dateRange" onchange="updateDateRange()" class="form-input">
                        <option value="7">7 Hari Terakhir</option>
                        <option value="30" selected>30 Hari Terakhir</option>
                        <option value="90">90 Hari Terakhir</option>
                        <option value="365">1 Tahun Terakhir</option>
                    </select>
                    <button onclick="exportReport()" class="btn-primary">
                        <i class="fas fa-download mr-2"></i>
                        Export Laporan
                    </button>
                </div>
            </div>
        </div>

        <!-- Analytics Content -->
        <div class="p-6">
            <!-- Key Metrics -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Total Revenue -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-green-100 rounded-full">
                            <i class="fas fa-dollar-sign text-green-600 text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Total Pendapatan</p>
                            <p class="text-2xl font-bold text-gray-800">Rp <%= analytics.revenue.toLocaleString('id-ID') %></p>
                            <p class="text-sm text-green-600">+<%= analytics.revenueGrowth %>% dari periode sebelumnya</p>
                        </div>
                    </div>
                </div>

                <!-- Total Orders -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-blue-100 rounded-full">
                            <i class="fas fa-shopping-cart text-blue-600 text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Total Pesanan</p>
                            <p class="text-2xl font-bold text-gray-800"><%= analytics.orders %></p>
                            <p class="text-sm text-blue-600">+<%= analytics.ordersGrowth %>% dari periode sebelumnya</p>
                        </div>
                    </div>
                </div>

                <!-- Average Order Value -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-yellow-100 rounded-full">
                            <i class="fas fa-chart-line text-yellow-600 text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Rata-rata Pesanan</p>
                            <p class="text-2xl font-bold text-gray-800">Rp <%= analytics.averageOrderValue.toLocaleString('id-ID') %></p>
                            <p class="text-sm text-yellow-600">+<%= analytics.aovGrowth %>% dari periode sebelumnya</p>
                        </div>
                    </div>
                </div>

                <!-- Conversion Rate -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-purple-100 rounded-full">
                            <i class="fas fa-percentage text-purple-600 text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Tingkat Konversi</p>
                            <p class="text-2xl font-bold text-gray-800"><%= analytics.conversionRate %>%</p>
                            <p class="text-sm text-purple-600">+<%= analytics.conversionGrowth %>% dari periode sebelumnya</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- Revenue Chart -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Tren Pendapatan</h3>
                    <canvas id="revenueChart" width="400" height="200"></canvas>
                </div>

                <!-- Orders Chart -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Tren Pesanan</h3>
                    <canvas id="ordersChart" width="400" height="200"></canvas>
                </div>
            </div>

            <!-- Product Performance -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- Top Selling Products -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Produk Terlaris</h3>
                    <div class="space-y-4">
                        <% topProducts.forEach((product, index) => { %>
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <div class="flex items-center space-x-3">
                                    <div class="w-8 h-8 bg-amber-100 rounded-full flex items-center justify-center">
                                        <span class="text-sm font-bold text-amber-600">#<%= index + 1 %></span>
                                    </div>
                                    <div>
                                        <p class="font-medium text-gray-800"><%= product.name %></p>
                                        <p class="text-sm text-gray-500"><%= product.category %></p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="font-semibold text-gray-800"><%= product.sold %> terjual</p>
                                    <p class="text-sm text-gray-500">Rp <%= product.revenue.toLocaleString('id-ID') %></p>
                                </div>
                            </div>
                        <% }); %>
                    </div>
                </div>

                <!-- Category Performance -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Performa Kategori</h3>
                    <div class="space-y-4">
                        <% categoryPerformance.forEach(category => { %>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="w-4 h-4 rounded-full" style="background-color: <%= category.color %>"></div>
                                    <span class="text-sm font-medium text-gray-800"><%= category.name %></span>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm font-semibold text-gray-800"><%= category.percentage %>%</p>
                                    <p class="text-xs text-gray-500">Rp <%= category.revenue.toLocaleString('id-ID') %></p>
                                </div>
                            </div>
                        <% }); %>
                    </div>
                </div>
            </div>

            <!-- Customer Analytics -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                <!-- New Customers -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Pelanggan Baru</h3>
                    <div class="text-center">
                        <p class="text-3xl font-bold text-blue-600"><%= analytics.newCustomers %></p>
                        <p class="text-sm text-gray-500">pelanggan baru</p>
                        <p class="text-sm text-green-600 mt-2">+<%= analytics.newCustomersGrowth %>% dari periode sebelumnya</p>
                    </div>
                </div>

                <!-- Repeat Customers -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Pelanggan Berulang</h3>
                    <div class="text-center">
                        <p class="text-3xl font-bold text-green-600"><%= analytics.repeatCustomers %></p>
                        <p class="text-sm text-gray-500">pelanggan berulang</p>
                        <p class="text-sm text-green-600 mt-2"><%= analytics.repeatRate %>% dari total pelanggan</p>
                    </div>
                </div>

                <!-- Customer Lifetime Value -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Customer Lifetime Value</h3>
                    <div class="text-center">
                        <p class="text-3xl font-bold text-purple-600">Rp <%= analytics.clv.toLocaleString('id-ID') %></p>
                        <p class="text-sm text-gray-500">rata-rata per pelanggan</p>
                        <p class="text-sm text-purple-600 mt-2">+<%= analytics.clvGrowth %>% dari periode sebelumnya</p>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Aktivitas Terbaru</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Waktu</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aktivitas</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Detail</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <% recentActivity.forEach(activity => { %>
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        <%= new Date(activity.timestamp).toLocaleString('id-ID') %>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                        <%= activity.action %>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        <%= activity.user %>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        <%= activity.details %>
                                    </td>
                                </tr>
                            <% }); %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Chart data
const revenueData = <%= JSON.stringify(analytics.revenueData) %>;
const ordersData = <%= JSON.stringify(analytics.ordersData) %>;

// Initialize charts
document.addEventListener('DOMContentLoaded', function() {
    // Revenue Chart
    const revenueCtx = document.getElementById('revenueChart').getContext('2d');
    new Chart(revenueCtx, {
        type: 'line',
        data: {
            labels: revenueData.map(item => new Date(item.date).toLocaleDateString('id-ID')),
            datasets: [{
                label: 'Pendapatan',
                data: revenueData.map(item => item.revenue),
                borderColor: 'rgb(34, 197, 94)',
                backgroundColor: 'rgba(34, 197, 94, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'Rp ' + value.toLocaleString('id-ID');
                        }
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'Pendapatan: Rp ' + context.parsed.y.toLocaleString('id-ID');
                        }
                    }
                }
            }
        }
    });

    // Orders Chart
    const ordersCtx = document.getElementById('ordersChart').getContext('2d');
    new Chart(ordersCtx, {
        type: 'bar',
        data: {
            labels: ordersData.map(item => new Date(item.date).toLocaleDateString('id-ID')),
            datasets: [{
                label: 'Pesanan',
                data: ordersData.map(item => item.orders),
                backgroundColor: 'rgba(59, 130, 246, 0.8)',
                borderColor: 'rgb(59, 130, 246)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
});

// Update date range
function updateDateRange() {
    const dateRange = document.getElementById('dateRange').value;
    window.location.href = `/admin/analytics?range=${dateRange}`;
}

// Export report
async function exportReport() {
    try {
        const dateRange = document.getElementById('dateRange').value;
        showNotification('Menyiapkan laporan...', 'info');
        
        const response = await fetch(`/admin/analytics/export?range=${dateRange}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `analytics-report-${new Date().toISOString().split('T')[0]}.xlsx`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            showNotification('Laporan berhasil diekspor', 'success');
        } else {
            const result = await response.json();
            showNotification(result.message, 'error');
        }
    } catch (error) {
        console.error('Error exporting report:', error);
        showNotification('Terjadi kesalahan saat mengekspor laporan', 'error');
    }
}

// Show notification function
function showNotification(message, type = 'info') {
    // Remove existing notifications
    const existingNotifications = document.querySelectorAll('.notification');
    existingNotifications.forEach(notification => notification.remove());

    // Create notification element
    const notification = document.createElement('div');
    notification.className = `notification fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm transform translate-x-full transition-transform duration-300`;
    
    // Set colors based on type
    const colors = {
        success: 'bg-green-500 text-white',
        error: 'bg-red-500 text-white',
        warning: 'bg-yellow-500 text-white',
        info: 'bg-blue-500 text-white'
    };
    
    notification.className += ` ${colors[type] || colors.info}`;
    
    // Add icon based on type
    const icons = {
        success: 'fas fa-check-circle',
        error: 'fas fa-exclamation-circle',
        warning: 'fas fa-exclamation-triangle',
        info: 'fas fa-info-circle'
    };
    
    notification.innerHTML = `
        <div class="flex items-center">
            <i class="${icons[type] || icons.info} mr-2"></i>
            <span>${message}</span>
            <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Animate in
    setTimeout(() => {
        notification.classList.remove('translate-x-full');
    }, 100);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (notification.parentElement) {
            notification.classList.add('translate-x-full');
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 300);
        }
    }, 5000);
}
</script>
